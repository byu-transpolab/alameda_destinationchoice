[
["results.html", " 4 Results 4.1 Model Application", " 4 Results library(tidyverse) library(mlogit) library(modelsummary) library(broom) library(kableExtra) library(sf) library(leaflet) knitr::opts_chunk$set(cache = TRUE) # overloaded methods for doing prediction with mlogit objects source(&quot;R/methods.R&quot;) # function to index a tibble for mnl estimation logit_converter &lt;- function(df) { dfidx(df, idx = list(&quot;id&quot;, &quot;alt&quot;), shape = &quot;long&quot;, choice = &quot;chosen&quot;, idnames = &quot;id&quot;, drop.index = FALSE) } # function to estimate the mnl model on a subset of data group_mnl &lt;- function(df){ tryCatch({ mlogit(chosen ~ yj_distance + yj_acres + playground + baseball + basketball + `football / soccer` + other_pitch + volleyball + tennis + trail | -1, data = df) }, error = function(e){ warning(e, &quot;could not estimate mnl&quot;) return(NA) }) } this_map = c( &quot;yj_distance&quot; = &quot;log(Distance)&quot;, &quot;yj_acres&quot; = &quot;log(Acres)&quot;, &quot;playgroundTRUE&quot; = &quot;Playground&quot;, &quot;trailTRUE&quot; = &quot;Trail&quot;, &quot;pitchTRUE&quot; = &quot;Sport Field&quot;, &quot;basketballTRUE&quot; = &quot;Basketball&quot;, &quot;baseballTRUE&quot; = &quot;Baseball&quot;, &quot;`football / soccer`TRUE&quot; = &quot;Football / Soccer&quot;, &quot;tennisTRUE&quot; = &quot;Tennis&quot;, &quot;volleyballTRUE&quot; = &quot;Volleyball&quot;, &quot;other_pitchTRUE&quot; = &quot;Other Sport&quot; ) this_crs &lt;- 2227 # EPSG:2227 – NAD83 / California zone 3 (ftUS) logitdata &lt;- read_rds(&quot;data/logitdata.rds&quot;) dfi &lt;- logit_converter(logitdata) estim &lt;- filter(dfi, validation) valid &lt;- filter(dfi, !validation) We estimated multinomial logit park activity location choice models including coefficients for the distance between the park and the home block group and the acreage of the park. We applied a Yeo-Johnson transformation (Yeo and Johnson 2000) to both distance and acreage; the Yeo-Johnson transformation replicates the constant marginal elasticity of a logarithmic transformation while avoiding undefined values (\\(YJ(0) = 0\\)). For simplicity, we call this transformation log() in the model results tables. Using a constant marginal elasticity is better reflective of how people perceive distances and sizes; a one-mile increase to a trip distance is more impactful to a one-mile trip than a ten-mile trip. base_models &lt;- list( &quot;Network Distance&quot; = mlogit( chosen ~ yj_distance + yj_acres | -1 , data = estim), &quot;Park Attributes&quot; = mlogit( chosen ~ yj_distance + yj_acres + playground + trail + pitch | -1 , data = estim), &quot;Sport Detail&quot; = mlogit( chosen ~ yj_distance + yj_acres + playground + baseball + basketball + `football / soccer` + other_pitch + volleyball + tennis + trail | -1 , data = estim) ) detail_lrt &lt;- lrtest(base_models[[2]], base_models[[3]])$`Pr(&gt;Chisq)`[2] d_ratio_base &lt;- -1 * coefficients(base_models$`Network Distance`)[1] / coefficients(base_models$`Network Distance`)[2] d_ratio_sport &lt;- -1 * coefficients(base_models$`Sport Detail`)[1] / coefficients(base_models$`Sport Detail`)[2] Table 4.1 presents the model estimation results for a series of models with different utility function definitions, each estimated on the complete set of synthetic choice makers. The first model — named “Network Distance” — only considers the distance to the park and the size of the park in the utility equation. The estimated coefficients are significant and of the expected sign: That is, individuals will travel further distances to reach larger parks. The ratio of the estimated coefficients implies that on average, people will travel 3.3089752 times further to reach a park twice as large. The second and third models in Table 4.1 include a vector of park attributes. In the model labeled “Park Attributes,” the presence of any sport field is considered with a single dummy value, and in the “Sport Detail” model this variable is disaggregated into facilities for different sports. The value of the size and distance coefficients change modestly from the “Network Distance” model, with the implied size to distance trade-off rising to 3.3089752. Examining the two amenities models — independently and in comparison with each other — reveals a few surprising findings. First, it appears that playgrounds and sport fields in general contribute negatively to the choice utility equation. This is both unintuitive and contradictory to previous findings in this space (e.g., Kinnell et al. 2006). Considering different sports separately, there is a wide variety of observed response with tennis and volleyball facilities attracting more trips, and football and basketball facilities attracting fewer, all else equal. Trails and walking paths give substantive positive utility in both models. The difference in likelihood statistics between the three models is significant (likelihood ratio test \\(p\\)-value 1.804975210^{-4}), and so in spite of the curious aggregate findings, we move forward with this utility specification. modelsummary( base_models, stars = TRUE, output = &quot;kableExtra&quot;, coef_map = this_map, gof_omit = &quot;BIC&quot;, title = &quot;Estimated Model Coefficients&quot; ) %&gt;% scroll_box(width = &quot;100%&quot;, box_css = &quot;border: 0px;&quot;) Table 4.1: Estimated Model Coefficients Network Distance Park Attributes Sport Detail log(Distance) -1.354*** -1.394*** -1.390*** (0.022) (0.022) (0.022) log(Acres) 0.409*** 0.353*** 0.348*** (0.011) (0.012) (0.012) Playground -0.437*** -0.551*** (0.049) (0.049) Trail 0.555*** 0.564*** (0.052) (0.053) Sport Field -0.324*** (0.050) Basketball -0.232*** (0.068) Baseball 0.067 (0.067) Football / Soccer -0.481*** (0.095) Tennis 0.236*** (0.066) Volleyball 0.615*** (0.135) Other Sport -0.191** (0.090) Num.Obs. 3971 3971 3971 AIC 11600.2 11306.5 11292.1 Log.Lik. -5798.103 -5648.236 -5636.028 rho2 rho20 0.391 0.407 0.408 * p &lt; 0.1, ** p &lt; 0.05, *** p &lt; 0.01 minority_models &lt;- estim %&gt;% mutate(group = case_when( black &gt; 30 ~ &quot;black&quot;, asian &gt; 30 ~ &quot;asian&quot;, TRUE ~ &quot;other&quot; )) %&gt;% filter(!is.na(group)) %&gt;% group_by(group) %&gt;% nest() %&gt;% ungroup() %&gt;% mutate( data = map(data, logit_converter), mnl = map(data, group_mnl) ) income_models &lt;- estim %&gt;% mutate(group = case_when(lowincome &gt; 30 ~ &quot;lowincome&quot;, highincome &gt; 50 ~ &quot;highincome&quot;, TRUE ~ &quot;other&quot;)) %&gt;% filter(!is.na(group)) %&gt;% group_by(group) %&gt;% nest() %&gt;% ungroup() %&gt;% mutate( data = map(data, logit_converter), mnl = map(data, group_mnl) ) child_models &lt;- estim %&gt;% mutate(group = case_when(children &gt; 25 ~ &quot;children&quot;, children &lt; 5 ~ &quot;few children&quot;, TRUE ~ &quot;other&quot;)) %&gt;% filter(!is.na(group)) %&gt;% group_by(group) %&gt;% nest() %&gt;% ungroup() %&gt;% mutate( data = map(data, logit_converter), mnl = map(data, group_mnl) ) models &lt;- list( &quot;&gt; 30% Asian&quot; = minority_models$mnl[[1]], &quot;&gt; 30% Black&quot; = minority_models$mnl[[3]], &quot;Other&quot; = minority_models$mnl[[2]], &quot;&gt; 30% Low income&quot; = income_models$mnl[[1]], &quot;&gt; 50% High income&quot; = income_models$mnl[[3]], &quot;Other&quot; = income_models$mnl[[2]], &quot;&gt; 25% children&quot; = child_models$mnl[[3]], &quot;&lt; 5% children&quot; = child_models$mnl[[2]], &quot;Other&quot; = child_models$mnl[[1]] ) It is worth investigating the heterogeneity in preferences that exist among different demographic groups. Though the income and ethnicity of the synthetic park visitors is not known, we can segment the estimation dataset based on the socioeconomic makeup of the visitors’ residence block group. The models presented in Table 4.2 were estimated on segments developed in this manner. Models under the “Minority” heading include a race-based segmentation: simulated individuals living in block groups with more than thirty percent Black persons are included in the “&gt;30% Black” model, an analogous segmentation for block groups with high Asian populations are in the “&gt;30% Asian” model, and the “Other” model contains all other block groups. Another set of model segmentation relies on the share of the population in each block group with household incomes above or below certain thresholds. Again, we use the threshold definitions based on in ??. modelsummary( models, stars = TRUE, output = &quot;kableExtra&quot;, coef_map = this_map, gof_omit = &quot;BIC&quot;, title = &quot;Estimated Model Coefficients with Block Group Segmentations&quot; ) %&gt;% add_header_above(c(&quot; &quot; = 1, &quot;Minority&quot; = 3, &quot;Income&quot; = 3, &quot;Children&quot; = 3)) %&gt;% scroll_box(width = &quot;100%&quot;, box_css = &quot;border: 0px;&quot;) Table 4.2: Estimated Model Coefficients with Block Group Segmentations Minority Income Children &gt; 30% Asian &gt; 30% Black Other &gt; 30% Low income &gt; 50% High income Other &gt; 25% children &lt; 5% children Other log(Distance) -1.329*** -1.523*** -1.377*** -1.419*** -1.310*** -1.395*** -1.235*** -1.595*** -1.398*** (0.038) (0.064) (0.031) (0.051) (0.051) (0.029) (0.059) (0.083) (0.026) log(Acres) 0.373*** 0.306*** 0.342*** 0.334*** 0.345*** 0.354*** 0.316*** 0.371*** 0.355*** (0.020) (0.032) (0.017) (0.027) (0.028) (0.015) (0.030) (0.043) (0.014) Playground -0.519*** -0.390*** -0.631*** -0.525*** -0.493*** -0.585*** -0.425*** -0.886*** -0.542*** (0.085) (0.121) (0.070) (0.104) (0.122) (0.063) (0.123) (0.179) (0.056) Trail 0.658*** 0.359*** 0.639*** 0.305*** 0.897*** 0.613*** 0.121 0.744*** 0.638*** (0.095) (0.128) (0.076) (0.109) (0.148) (0.068) (0.126) (0.191) (0.062) Basketball -0.009 -0.346* -0.414*** -0.172 -0.110 -0.294*** -0.322* -0.289 -0.208*** (0.109) (0.184) (0.102) (0.153) (0.160) (0.088) (0.172) (0.262) (0.078) Baseball 0.128 0.172 -0.025 0.026 -0.104 0.132 0.140 -0.070 0.074 (0.111) (0.172) (0.097) (0.146) (0.164) (0.085) (0.168) (0.254) (0.076) Football / Soccer -0.473*** -1.060*** -0.348** -0.866*** -0.249 -0.443*** -0.168 -0.941*** -0.527*** (0.154) (0.283) (0.138) (0.226) (0.223) (0.120) (0.229) (0.356) (0.110) Tennis 0.388*** -0.518** 0.322*** -0.080 0.661*** 0.207** 0.344** -0.038 0.237*** (0.108) (0.210) (0.095) (0.163) (0.146) (0.085) (0.163) (0.264) (0.076) Volleyball 0.709*** -0.077 0.460** 0.435 0.454* 0.604*** 0.552* 0.446 0.617*** (0.197) (0.615) (0.212) (0.403) (0.257) (0.177) (0.329) (0.537) (0.154) Other Sport -0.082 -0.396 -0.251* -0.492** -0.069 -0.178 0.252 -0.540 -0.265** (0.145) (0.270) (0.132) (0.234) (0.188) (0.117) (0.218) (0.355) (0.104) Num.Obs. 1365 579 2027 777 758 2436 544 358 3069 AIC 3938.8 1738.7 5560.5 2396.8 1908.7 6974.1 1810.8 894.5 8572.7 Log.Lik. -1959.423 -859.375 -2770.253 -1188.423 -944.365 -3477.025 -895.408 -437.255 -4276.373 rho2 rho20 0.401 0.381 0.430 0.362 0.480 0.405 0.314 0.491 0.419 * p &lt; 0.1, ** p &lt; 0.05, *** p &lt; 0.01 The model estimates in Table 4.2 reveal that there is noticeable heterogeneity in the response among different socioeconomic groups. Park visitors living in block groups with a high proportion of Black and low-income residents show less affinity for trails and other walkways, but appear are also considerably to be more sensitive to the distance of a park. Visitors living in high-income neighborhoods are more attracted to the amenities of a park, or rather these visitors do not show significant negative coefficients for amenities, e.g. basketball courts and football fields. # write a function to estimate multiple MNL models on different # segments of the estimation data estimate_split_models &lt;- function(data, var, splits) { lapply(splits, function(p){ data %&gt;% filter(.data[[var]] &gt; p) %&gt;% tibble() %&gt;% mutate(share = p) }) %&gt;% bind_rows() %&gt;% group_by(share) %&gt;% nest() %&gt;% mutate( data = map(data, logit_converter), mnl = map(data, group_mnl), coef = map(mnl, tidy) ) } splits &lt;- c(0, 5, 10, 15, 20, 30, 40) split_models &lt;- lapply(c(&quot;black&quot;, &quot;asian&quot;, &quot;lowincome&quot;, &quot;highincome&quot;, &quot;children&quot;), function(var) { estimate_split_models(estim, var, splits) %&gt;% mutate(Segmentation = var) }) %&gt;% bind_rows() Seeing that there is a difference in the response in the model segmentation, it is also worth considering the role of our segmentation thresholds in these findings. Figure 4.1 shows the estimated coefficients and confidence intervals for these different amenities at different threshold levels of segmentation. The threshold level means that at least that percent of the block group’s population falls in that category. The confidence intervals widen as more observations are excluded from the model. The estimated coefficients for the different segmentations are identical when the share equals zero, and simply represent the “Sport Detail” model from Table 4.1. Overall, increasing the segmentation threshold level reveals some additional information about user preferences. First, it should be noted that there is some inconsistency: for instance, block groups with at least 40% of low income households show a lower importance of distance than block groups with either 30% or 50% low income households. The increasing width of the confidence interval, however, means it is difficult to make generalized statements. Residents of block groups with a higher share of Asian or high income households both show relatively more affinity for tennis courts and trails. Block groups with high Black populations show a somewhat greater preference for playgrounds, as well appearing to be the most distance-sensitive group. # extract the coefficients you need to plot dat &lt;- modelplot(split_models$mnl %&gt;% setNames(str_c(split_models$Segmentation, split_models$share, sep = &quot;_&quot;)), coef_map = this_map, draw = FALSE) %&gt;% separate(model, into = c(&quot;Segmentation&quot;, &quot;share&quot;), convert = TRUE, sep = &quot;_&quot;) %&gt;% mutate( Segmentation = case_when( Segmentation == &quot;black&quot; ~ &quot;Black&quot;, Segmentation == &quot;asian&quot; ~ &quot;Asian&quot;, Segmentation == &quot;lowincome&quot; ~ &quot;Income &lt; $35k&quot;, Segmentation == &quot;highincome&quot; ~ &quot;Income &gt; $125k&quot;, Segmentation == &quot;children&quot; ~ &quot;Children under 6&quot; ) ) # make the plot these_colors &lt;- wesanderson::wes_palettes$Darjeeling1 split_plots &lt;- ggplot(dat, aes(x = share, y = estimate, ymin = conf.low, ymax = conf.high, color = Segmentation, fill = Segmentation)) + theme_minimal() + geom_line() + geom_ribbon(alpha = 0.05, size = 0.1, lty = &quot;dotted&quot;) + facet_wrap(~ fct_rev(term), scales = &quot;free_y&quot;, ncol = 3) + scale_color_manual(values = these_colors) + scale_fill_manual(values = these_colors) + xlab(&quot;Percent of Block Group Population&quot;) + ylab(&quot;Estimated coefficient and 95% confidence interval&quot;) if(knitr::is_latex_output()) { lemon::reposition_legend(split_plots, position = &#39;top left&#39;, panel = &quot;panel-3-4&quot;) } else { plotly::ggplotly(split_plots) } ## Warning: `group_by_()` is deprecated as of dplyr 0.7.0. ## Please use `group_by()` instead. ## See vignette(&#39;programming&#39;) for more help ## This warning is displayed once every 8 hours. ## Call `lifecycle::last_warnings()` to see where this warning was generated. Figure 4.1: Estimated utility coefficients and 95% confidence intervals for park amenities at different socioeconomic threshold levels. 4.1 Model Application In spring and summer 2020, cities across the world responded to the COVID-19 pandemic by converting city streets into temporary pedestrian plazas. The stated goals of this policy included providing recreational space that would allow people to walk and exercise outside with sufficient personal space and less risk of conflict from vehicle traffic. This policy created several dozen temporary open spaces in urbanized areas of the county. In this section, we apply the models estimated above to evaluate the benefits of this policy in terms of aggregate value, as well as the equity of the policy with respect to different income and ethnic groups. attributed_parks &lt;- read_rds(&quot;data/attributed_parks.rds&quot;) slowstreets &lt;- st_read(&quot;data/slow_streets.geojson&quot;) %&gt;% st_transform(this_crs) ## Reading layer `slow_streets&#39; from data source `/Users/gregmacfarlane/projects/alameda_destinationchoice/data/slow_streets.geojson&#39; using driver `GeoJSON&#39; ## Simple feature collection with 74 features and 8 fields ## geometry type: MULTILINESTRING ## dimension: XY ## bbox: xmin: -13614010 ymin: 4542899 xmax: -13599190 ymax: 4561117 ## CRS: 3857 street_parks &lt;- slowstreets %&gt;% st_buffer(dist = 25) %&gt;% # 50 foot wide park ( 4 lanes of traffic) mutate(acres = as.numeric(st_area(.)) / 43560) %&gt;% mutate() %&gt;% transmute( id = str_c(&quot;st&quot;, ID), access = &quot;Open Access&quot;, acres, type = &quot;Street&quot;, yj_acres = VGAM::yeo.johnson(acres, lambda = 0), playground = FALSE, baseball = FALSE, basketball = FALSE, `football / soccer` = FALSE, other_pitch = FALSE, volleyball = FALSE, tennis = FALSE, pitch = FALSE, trail = TRUE, attractions = NA ) We obtained the list of streets in Alameda County that were reported closed in the “Shifting Streets” COVID-19 mobility dataset (Combs et al. 2020). This dataset reports that 74 individual streets were closed to vehicle traffic (and thereby opened as public spaces); these streets represent 27.5730459 total miles across the cities of Berkeley, Oakland, and Alameda. For the purposes of this analysis, we represent each closed street as a single “park” without any sport facilities or playgrounds, but with a trail / walking path. The database provides the closed streets as polyline objects; we assert a 25-foot buffer around the line to represent a polygon with a measurable area. Finally, we measure the network-based distance from each population-weighted block group centroid to the nearest boundary of each closed park. # distances computed in py/shortest_paths.py path_files &lt;- dir(&quot;data/streets/&quot;, full.names = TRUE) street_distances &lt;- lapply(path_files, function(file) { read_csv(file, col_types = list(geoid = col_character(), park_id = col_character())) %&gt;% mutate( yj_distance = VGAM::yeo.johnson(distance, lambda = 0), yj_euc_dist = VGAM::yeo.johnson(euc_dist, lambda = 0) ) }) %&gt;% bind_rows() %&gt;% rename(home = geoid, park = park_id) %&gt;% mutate(home = sprintf(&quot;%012s&quot;, home)) # read data on streets and distances distance_df &lt;- read_rds(&quot;data/distances.rds&quot;) attributed_parks &lt;- read_rds(&quot;data/attributed_parks.rds&quot;) %&gt;% mutate(chosen = FALSE) %&gt;% ungroup() attributed_parks$chosen[55] &lt;- TRUE # create base situation prediction dataset base_choices &lt;- distance_df %&gt;% left_join(attributed_parks, by = c(&quot;park&quot; = &quot;id&quot;)) %&gt;% rename(id = home, alt = park) %&gt;% logit_converter() # create streets situation prediction dataset, augmented by street parks street_choices &lt;- left_join( bind_rows(street_distances, distance_df), bind_rows(street_parks %&gt;% mutate(chosen = FALSE, attractions = FALSE), attributed_parks), by = c(&quot;park&quot; = &quot;id&quot;)) %&gt;% rename(id = home, alt = park) %&gt;% logit_converter() Using this new dataset — augmented with parks added by street openings — we applied the “Sport Detail” non-segmented model to calculate park choice utilities and utility-based accessibility values for each block group in Alameda County. As discussed in Section 3.2, the difference in accessibility values provides a means to evaluate the benefit of the policy in a By comparing the difference in accessibility valuation with and without the street “parks” we can evaluate the monetary benefit of the policy. The dataset used for this research does not have any information on travel costs or entrance fees, and such data would likely not be relevant in the context of urban parks. As a result, there is no direct link between the utility and a monetary cost in this model directly. As a substitution, the regional travel model employed by MTC (the MPO) uses a cost coefficient of \\(-0.6\\) divided by the simulated agents’s value of time to determine destination choices for non-work trips.1 This value of time varies by the agent’s income, but using the population median value of $7.75 per hour results in a cost coefficient on the destination choice utility of \\(-0.215\\). Dividing the difference in accessibility logsums by the negative of this value can provide an initial estimate of the monetary value of the policy to each park user. logsums &lt;- lapply(list(&quot;Base&quot; = base_choices, &quot;Streets&quot; = street_choices), function(df){ u &lt;- predict(base_models$`Sport Detail`, newdata = df, type = &quot;linpred&quot;) logsum &lt;- log(rowSums(exp(u))) list( u = u, logsum = logsum ) }) logsums_tibble &lt;- tibble( geoid = names(logsums$Base$logsum), base = logsums$Base$logsum, streets = logsums$Streets$logsum ) blockgroups &lt;- read_rds(&quot;data/blockgroups.rds&quot;) %&gt;% left_join(logsums_tibble, by = &quot;geoid&quot;) %&gt;% mutate(diff_ls = (streets - base) / 0.215) Figure 4.2 presents this monetary valuation spatially. Unsurprisingly, the benefits are concentrated in the block groups surrounding the opened streets. Most residents of central Oakland see a benefit of somewhere around $1, while some zones see an equivalent benefit of as much as $30. There is some benefit assigned just for having more options, though this is small and on the order of 10 cents for most block groups away from where the street openings occured. diff_pal &lt;- colorBin( palette = as.character(wesanderson::wes_palette(&quot;Zissou1&quot;)), domain = blockgroups$diff_ls, #bins = quantile(blockgroups$diff_ls, probs = c(0, 0.1, 0.3, 0.4, 0.5, 0.8, 0.9, 1)) bins = c(0, 0.1, 0.25, 0.5, 1, 2, 10, 35) ) leaflet(data = blockgroups %&gt;% st_transform(4326)) %&gt;% addProviderTiles(providers$Esri.WorldGrayCanvas) %&gt;% addPolygons(fillColor = ~diff_pal(diff_ls), stroke = FALSE, fillOpacity = 1) %&gt;% addPolylines(data = slowstreets %&gt;% st_transform(4326), color = &quot;green&quot;) %&gt;% addLegend(&quot;bottomleft&quot;, pal = diff_pal, values = ~diff_ls, title = &quot;Value of Street Opening&quot;) Figure 4.2: Monetary value of street opening to residents based on utility change. An important consideration is the equity of the added benefit among households of different races and incomes. References "]
]
