# Results

```{r estimation-setup, message=FALSE, warning=FALSE, cache = FALSE}
library(tidyverse)
library(mlogit)
library(modelsummary)
library(broom)
library(kableExtra)
library(sf)
library(leaflet)
knitr::opts_chunk$set(cache = TRUE)

# overloaded methods for doing prediction with mlogit objects
source("R/methods.R")

# function to index a tibble for mnl estimation
logit_converter <- function(df) {
  dfidx(df, idx = list("id", "alt"), shape = "long",  
      choice = "chosen", idnames = "id", drop.index = FALSE)
}

# function to estimate the mnl model on a subset of data
group_mnl <- function(df){
  tryCatch({
    mlogit(chosen ~ yj_distance + yj_acres + playground + baseball +  basketball +
             `football / soccer` + other_pitch + volleyball + tennis + trail | -1,
           data = df)
  }, error = function(e){
    warning(e, "could not estimate mnl")
    return(NA)
  })
}

this_map = c(
    "yj_distance" = "log(Distance)",
    "yj_acres" = "log(Acres)",
    "playgroundTRUE" = "Playground",
    "trailTRUE" = "Trail",
    "pitchTRUE" = "Sport Field",
    "basketballTRUE" = "Basketball",
    "baseballTRUE" = "Baseball",
    "`football / soccer`TRUE" = "Football / Soccer",
    "tennisTRUE" = "Tennis",
    "volleyballTRUE" = "Volleyball",
    "other_pitchTRUE" = "Other Sport"
  )

this_crs <- 2227 # EPSG:2227 â€“ NAD83 / California zone 3 (ftUS)
```


```{r load}
logitdata <- read_rds("data/logitdata.rds")
dfi <- logit_converter(logitdata)
estim <- filter(dfi, validation)
valid <- filter(dfi, !validation)
```

We estimated multinomial logit park activity location choice models including
coefficients for the distance between the park and the home block group and the
acreage of the park. We applied a Yeo-Johnson transformation [@Yeo2000] to both
distance and acreage; the Yeo-Johnson transformation replicates the constant
marginal elasticity of a logarithmic transformation while avoiding undefined
values ($YJ(0) = 0$). For simplicity, we call this transformation `log()` in the
model results tables. Using a constant marginal elasticity is better reflective
of how people perceive distances and sizes; a one-mile increase to a trip
distance is more impactful to a one-mile trip than a ten-mile trip.

```{r base_models}
base_models <- list(
  "Network Distance"   = mlogit(
    chosen ~ yj_distance + yj_acres | -1 ,  data = estim),
  "Park Attributes"    = mlogit(
    chosen ~ yj_distance + yj_acres +  playground + trail + pitch | -1 , 
    data = estim),
  "Sport Detail"    = mlogit(
    chosen ~ yj_distance + yj_acres + playground + baseball +  basketball +
      `football / soccer` + other_pitch + volleyball + tennis + trail | -1 , 
    data = estim)
)
detail_lrt <- lrtest(base_models[[2]], base_models[[3]])$`Pr(>Chisq)`[2]
d_ratio_base <- -1 * coefficients(base_models$`Network Distance`)[1] / 
  coefficients(base_models$`Network Distance`)[2] 
d_ratio_sport <- -1 * coefficients(base_models$`Sport Detail`)[1] / 
  coefficients(base_models$`Sport Detail`)[2] 
```

Table \@ref(tab:base-modelsummary) presents the model estimation results for a
series of models with different utility function definitions, each estimated on the 
complete set of synthetic choice makers. The first model  --- named "Network 
Distance" --- only considers the distance to the park and the size of the park
in the utility equation. The estimated coefficients are significant and of the 
expected sign: That is, individuals will travel further distances to reach larger
parks. The ratio of the estimated coefficients implies that on average, people
will travel `r d_ratio_base` times further to reach a park twice as large.

The second and third models in Table \@ref(tab:base-modelsummary) include a 
vector of park attributes. In the model labeled "Park Attributes," the presence
of any sport field is considered with a single dummy value, and in the "Sport 
Detail" model this variable is disaggregated into facilities for different 
sports. The value of the size and distance coefficients change modestly from
the "Network Distance" model, with the implied size to distance trade-off rising
to `r d_ratio_base`. Examining the two amenities models --- independently and in 
comparison with each other --- reveals a few surprising findings. First, it 
appears that playgrounds and sport fields in general contribute *negatively* to 
the choice utility equation. This is both unintuitive and contradictory to
previous findings in this space [e.g.,  @Kinnell2006]. Considering different
sports separately, there is a wide variety of observed response with tennis and
volleyball facilities attracting more trips, and football and basketball
facilities attracting fewer, all else equal. Trails and walking paths give 
substantive positive utility in both models. The difference in likelihood statistics
between the three models is significant (likelihood ratio test 
$p$-value  `r detail_lrt`), and so in spite of the curious aggregate findings,
we move forward with this utility specification.

```{r base-modelsummary}
modelsummary(
  base_models, stars = TRUE, output = "kableExtra",
  coef_map = this_map, gof_omit = "BIC",
  title = "Estimated Model Coefficients"
) %>%
  scroll_box(width = "100%", box_css = "border: 0px;")
```


```{r grouped_models}
minority_models <- estim %>%
  mutate(group = case_when(
    black > 30 ~ "black",
    asian > 30 ~ "asian",
    TRUE ~ "other"
  )) %>%
  filter(!is.na(group)) %>%
  group_by(group) %>% nest() %>% ungroup() %>%
  mutate(
    data = map(data, logit_converter),
    mnl = map(data, group_mnl)
  ) 
income_models <- estim %>%
  mutate(group = case_when(lowincome > 30 ~ "lowincome", 
                           highincome > 50 ~ "highincome", TRUE ~ "other")) %>%
  filter(!is.na(group)) %>%
  group_by(group) %>% nest() %>% ungroup() %>%
  mutate(
    data = map(data, logit_converter),
    mnl = map(data, group_mnl)
  )
child_models <- estim %>%
  mutate(group = case_when(children > 25 ~ "children", 
                           children < 5 ~ "few children", TRUE ~ "other")) %>%
  filter(!is.na(group)) %>%
  group_by(group) %>% nest() %>% ungroup() %>%
  mutate(
    data = map(data, logit_converter),
    mnl = map(data, group_mnl)
  )
models <- list(
  "> 30% Asian" = minority_models$mnl[[1]],
  "> 30% Black" = minority_models$mnl[[3]],
  "Other" = minority_models$mnl[[2]],
  "> 30% Low income" = income_models$mnl[[1]],
  "> 50% High income" = income_models$mnl[[3]],
  "Other" = income_models$mnl[[2]],
  "> 25% children" = child_models$mnl[[3]],
  "< 5% children" = child_models$mnl[[2]],
  "Other" = child_models$mnl[[1]]
)
```

It is worth investigating the heterogeneity in preferences that exist among
different demographic groups. Though the income and ethnicity of the synthetic
park visitors is not known, we can segment the estimation dataset based on the
socioeconomic makeup of the visitors' residence block group. The models presented in 
Table \@ref(tab:grouped-modelsummary) were
estimated on segments developed in this manner. 
Models under the "Minority" heading include a
race-based segmentation: simulated individuals living in block groups with more
than thirty percent Black persons are included in the ">30% Black" model, an
analogous segmentation for block groups with high Asian populations are in the
">30% Asian" model, and the "Other" model contains all other block groups.
Another set of model segmentation relies on the share of the population in each
block group with household incomes above or below certain thresholds. Again,
we use the threshold definitions based on in \@ref(tab:acs-table).

```{r grouped-modelsummary}
modelsummary(
  models, stars = TRUE, output = "kableExtra",
  coef_map = this_map, gof_omit = "BIC",
  title = "Estimated Model Coefficients with Block Group Segmentations"
) %>%
  add_header_above(c(" " = 1, "Minority" = 3, "Income" = 3, "Children" = 3)) %>%
  scroll_box(width = "100%", box_css = "border: 0px;")
```

The model estimates in Table \@ref(tab:grouped-modelsummary) reveal that there 
is noticeable heterogeneity in the response among different socioeconomic
groups. Park visitors living in block groups with a high proportion of Black and
low-income residents show less affinity for trails and other walkways, but
appear are also considerably to be more sensitive to the distance of a park.
Visitors living in high-income neighborhoods are more attracted to the amenities
of a park, or rather these visitors do not show significant negative
coefficients for amenities,  e.g. basketball courts and football fields.

  
```{r split_models}
# write a function to estimate multiple MNL models on different 
# segments of the estimation data
estimate_split_models <- function(data, var, splits) {
  lapply(splits, function(p){
    data %>% 
      filter(.data[[var]] > p) %>% tibble() %>%
      mutate(share = p)
  }) %>%
    bind_rows() %>% group_by(share) %>% nest() %>%
    mutate(
      data = map(data, logit_converter),
      mnl = map(data, group_mnl),
      coef = map(mnl, tidy)
    )
}

splits <- c(0, 5, 10, 15, 20, 30, 40)
split_models <- lapply(c("black", "asian", "lowincome", "highincome", "children"), function(var) {
  estimate_split_models(estim, var, splits) %>%
    mutate(Segmentation = var)
}) %>% bind_rows() 
```

Seeing that there is a difference in the response in the model segmentation, 
it is also worth considering the role of our segmentation thresholds in these
findings. Figure \@ref(fig:split-plots) shows the estimated coefficients and 
confidence intervals for these different amenities at different threshold levels
of segmentation. The threshold level means that at least that percent
of the block group's population falls in that category. The confidence intervals
widen as more observations are excluded from the model. The estimated coefficients
for the different segmentations are identical when the share equals zero, and 
simply represent the "Sport Detail" model from Table \@ref(tab:base-modelsummary).

Overall, increasing the segmentation threshold level reveals some additional 
information about user preferences. First, it should be noted that there is
some inconsistency: for instance, block groups with at least 40% of low income
households show a lower importance of distance than block groups with either
30% or 50% low income households. The increasing width of the confidence interval, 
however, means it is difficult to make generalized statements. Residents of
block groups with a higher share of Asian or high income households both show
relatively more affinity for tennis courts and trails. Block groups with high
Black populations show a somewhat greater preference for playgrounds, as well 
appearing to be the most distance-sensitive group.

```{r split-plots, fig.cap="Estimated utility coefficients and 95% confidence intervals for park amenities at different socioeconomic threshold levels.", fig.height=7.5, cache = FALSE}
# extract the coefficients you need to plot
dat <- modelplot(split_models$mnl %>% 
            setNames(str_c(split_models$Segmentation, split_models$share, sep = "_")),
          coef_map = this_map, draw = FALSE) %>%
  separate(model, into = c("Segmentation", "share"), convert = TRUE, sep = "_") %>%
  mutate(
    Segmentation = case_when(
      Segmentation == "black" ~ "Black",
      Segmentation == "asian" ~ "Asian",
      Segmentation == "lowincome" ~ "Income < $35k",
      Segmentation == "highincome" ~ "Income > $125k",
      Segmentation == "children" ~ "Children under 6"
    )
  )

# make the plot
these_colors <- wesanderson::wes_palettes$Darjeeling1
split_plots <- ggplot(dat, aes(x = share, y = estimate, ymin = conf.low, ymax = conf.high, 
                color = Segmentation, fill = Segmentation)) + 
  theme_minimal() +
  geom_line() + 
  geom_ribbon(alpha = 0.05, size = 0.1, lty = "dotted") + 
  facet_wrap(~ fct_rev(term), scales = "free_y", ncol = 3)  + 
  scale_color_manual(values = these_colors) + 
  scale_fill_manual(values = these_colors) + 
  xlab("Percent of Block Group Population") + 
  ylab("Estimated coefficient and 95% confidence interval")

if(knitr::is_latex_output()) {
  lemon::reposition_legend(split_plots, position = 'top left', panel = "panel-3-4")
} else {
  plotly::ggplotly(split_plots)
}
```



## Model Application

In spring and summer 2020, cities across the world responded to the COVID-19
pandemic by converting city streets into temporary pedestrian plazas. The stated
goals of this policy included providing recreational space that would allow
people to walk and exercise outside with sufficient personal space and less risk
of conflict from vehicle traffic. This policy created several dozen temporary
open spaces in urbanized areas of the county. In this section, we apply the
models estimated above to evaluate the benefits of this policy in terms of
aggregate value, as well as the equity of the policy with respect to different
income and ethnic groups.

```{r closed-streets}
attributed_parks <- read_rds("data/attributed_parks.rds")
slowstreets <- st_read("data/slow_streets.geojson")  %>%
  st_transform(this_crs) 

street_parks <- slowstreets %>%
  st_buffer(dist = 25)  %>% # 50 foot wide park ( 4 lanes of traffic)
  mutate(acres = as.numeric(st_area(.)) / 43560) %>% 
  mutate() %>%
  transmute(
    id = str_c("st", ID), access = "Open Access", acres, type = "Street",
    yj_acres = VGAM::yeo.johnson(acres, lambda = 0),
    playground = FALSE, baseball = FALSE, basketball = FALSE, 
    `football / soccer` = FALSE, other_pitch = FALSE, volleyball = FALSE,
    tennis = FALSE, pitch = FALSE, trail = TRUE, attractions = NA
  )
  
```

We obtained the list of streets in Alameda County that were reported closed
in the "Shifting Streets" COVID-19 mobility dataset [@slowstreets]. This dataset
reports that `r nrow(street_parks)` individual streets were closed to vehicle
traffic (and thereby opened as public spaces); these streets represent 
`r as.numeric(sum(st_length(slowstreets))) / 5280` total miles across the cities
of Berkeley, Oakland, and Alameda. For the purposes of this analysis, we
represent each closed street as a single "park" without any sport facilities or
playgrounds, but with a trail / walking path. The database provides the closed 
streets as polyline objects; we assert a 25-foot buffer around the line to
represent a polygon with a measurable area. Finally, we measure the network-based
distance from each population-weighted block group centroid to the nearest 
boundary of each closed park.

```{r street_distances}
# distances computed in py/shortest_paths.py
path_files <- dir("data/streets/", full.names = TRUE)
street_distances <- lapply(path_files, function(file) {
  read_csv(file, col_types = list(geoid = col_character(), park_id = col_character())) %>%
  mutate(
    yj_distance = VGAM::yeo.johnson(distance, lambda = 0),
    yj_euc_dist = VGAM::yeo.johnson(euc_dist, lambda = 0)
  )
}) %>%
  bind_rows() %>%
  rename(home = geoid, park = park_id) %>%
  mutate(home = sprintf("%012s", home))
```


```{r choices}
# read data on streets and distances
distance_df <- read_rds("data/distances.rds")
attributed_parks <- read_rds("data/attributed_parks.rds") %>%
  mutate(chosen = FALSE) %>% ungroup()
attributed_parks$chosen[55] <- TRUE

# create base situation prediction dataset
base_choices <- distance_df %>%
  left_join(attributed_parks, by = c("park" = "id")) %>% 
  rename(id = home, alt = park) %>%
  logit_converter()

# create streets situation prediction dataset, augmented by street parks
street_choices <-  left_join(
  bind_rows(street_distances, distance_df),
  bind_rows(street_parks %>% mutate(chosen = FALSE, attractions = FALSE), 
            attributed_parks),
  by = c("park" = "id")) %>%
  rename(id = home, alt = park) %>%
  logit_converter()
```

Using this new dataset --- augmented with parks added by street openings --- we
applied the "Sport Detail" non-segmented model to calculate park choice utilities 
and utility-based accessibility values for each block group in Alameda County. 
As discussed in Section \@ref(model), the difference in accessibility values 
provides a means to evaluate the benefit of the policy in a By comparing the
difference in accessibility valuation with and without the street "parks" we can
evaluate the monetary benefit of the policy. 

The dataset used for this research
does not have any information on travel costs or entrance fees, and such data
would likely not be relevant in the context of urban parks. As a result, there
is no direct link between the utility and a monetary cost in this model directly.
As a substitution, the regional travel model employed by MTC (the MPO) uses a 
cost coefficient of $-0.6$ divided by the simulated agents's value of time to determine
destination choices for non-work trips.^[To be precise, this is the cost coefficient
on the mode choice for social, recreational, and other trip purposes, which 
influences destination choice as a logsum-based impedance term.] This value of
time varies by the agent's income, but using the population median value of
$7.75 per hour results in a cost coefficient on the destination choice utility
of $-0.215$. Dividing the difference in accessibility logsums by the negative of 
this value can provide an initial estimate of the monetary value of the policy
to each park user.

```{r logsums}
logsums <- lapply(list("Base" = base_choices, "Streets" = street_choices), function(df){
  u <- predict(base_models$`Sport Detail`, newdata = df, type = "linpred")
  logsum <- log(rowSums(exp(u)))
  list( u = u, logsum = logsum )
})

logsums_tibble <- tibble(
  geoid = names(logsums$Base$logsum),
  base = logsums$Base$logsum,
  streets = logsums$Streets$logsum
)

blockgroups <- read_rds("data/blockgroups.rds") %>%
  left_join(logsums_tibble, by = "geoid") %>%
  mutate(diff_ls = (streets - base) / 0.215)
```

Figure \@ref(fig:logsumsmap) presents this monetary valuation spatially.
Unsurprisingly, the benefits are concentrated in the block groups surrounding
the opened streets. Most residents of central Oakland see a benefit of somewhere
around \$1, while some zones see an equivalent benefit of as much as \$30. 
There is some benefit assigned just for having more options, though this is small
and on the order of 10 cents for most block groups away from where the 
street openings occured.

```{r logsumsmap, fig.cap="Monetary value of street opening to residents based on utility change." }
diff_pal <- colorBin(
  palette = as.character(wesanderson::wes_palette("Zissou1")),
  domain = blockgroups$diff_ls,
  #bins = quantile(blockgroups$diff_ls, probs = c(0, 0.1, 0.3, 0.4, 0.5, 0.8, 0.9, 1))
  bins = c(0, 0.1, 0.25, 0.5, 1, 2, 10, 35)
)

leaflet(data = blockgroups %>% st_transform(4326)) %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
  addPolygons(fillColor = ~diff_pal(diff_ls), 
              stroke = FALSE, fillOpacity = 1) %>%
  addPolylines(data = slowstreets %>% st_transform(4326), color = "green") %>%
  addLegend("bottomleft", pal = diff_pal, values = ~diff_ls, title = "Value of Street Opening")
```

An important consideration is the equity of the added benefit among households
of different races and incomes.

```{r equity}

```




